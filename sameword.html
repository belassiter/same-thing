<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Say the Same Thing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Styles for active and inactive tabs */
        .tab-active { background-color: #4f46e5; color: white; }
        .tab-inactive { background-color: #e5e7eb; color: #4b5563; }
        /* Common styles for inputs and buttons */
        .input-style {
            margin-top: 0.25rem; display: block; width: 100%;
            padding: 0.75rem 1rem; background-color: #f9fafb;
            border: 1px solid #d1d5db; border-radius: 0.5rem;
            box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05);
            transition: all 150ms ease-in-out;
        }
        .input-style:focus {
            outline: none; ring: 2px; ring-offset: 2px;
            ring-color: #4f46e5; border-color: #4f46e5;
        }
        .input-error {
            border-color: #ef4444;
        }
        .input-error:focus {
            ring-color: #ef4444;
            border-color: #ef4444;
        }
        .btn {
            margin-top: 1rem; width: 100%; font-weight: 700;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            transition: all 150ms ease-in-out;
            transform-origin: center;
        }
        .btn:hover { transform: scale(1.02); }
        .btn:focus { outline: none; ring: 4px; ring-opacity: 0.5; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:focus { ring-color: #4f46e5; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .btn-secondary { background-color: #3b82f6; color: white; }
        .btn-secondary:hover { background-color: #2563eb; }
        .btn-secondary:focus { ring-color: #3b82f6; }
        .btn-secondary:disabled { background-color: #93c5fd; cursor: not-allowed; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-success:focus { ring-color: #16a34a; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-danger:focus { ring-color: #dc2626; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8 space-y-6">
        
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Say the Same Thing</h1>
        </div>

        <div class="flex border-b border-gray-200">
            <button id="local-tab" class="tab-active flex-1 py-2 px-4 rounded-t-lg focus:outline-none">Local</button>
            <button id="remote-tab" class="tab-inactive flex-1 py-2 px-4 rounded-t-lg focus:outline-none">Remote</button>
        </div>

        <!-- =========== LOCAL GAME MODE =========== -->
        <div id="local-mode-content">
            <p id="local-instruction-text" class="text-center text-gray-500 mt-2">Player 1, enter a word.</p>
            <h2 id="local-round-display" class="text-xl font-semibold text-center text-gray-600">Round 1</h2>
            <div id="local-game-area">
                <div id="local-player1-turn">
                    <label for="local-word1" class="block text-sm font-medium text-gray-700">Player 1's Word</label>
                    <input type="text" id="local-word1" class="input-style" placeholder="e.g., Ran">
                    <p id="local-word1-error" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>
                <div id="local-player2-turn" class="hidden">
                    <label for="local-word2" class="block text-sm font-medium text-gray-700">Player 2's Word</label>
                    <input type="text" id="local-word2" class="input-style" placeholder="e.g., Running">
                    <p id="local-word2-error" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>
                <button id="local-main-button" class="btn btn-primary">Say It!</button>
            </div>
        </div>

        <!-- =========== REMOTE GAME MODE =========== -->
        <div id="remote-mode-content" class="hidden">
            <div id="room-selection-area" class="space-y-4 text-center">
                <p class="text-gray-600">Create a private room, then tell your friend the code to join your room.</p>
                <button id="create-room-btn" class="btn btn-primary">Create Private Room</button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-400">OR</span><div class="flex-grow border-t border-gray-300"></div></div>
                <div class="space-y-2">
                    <input type="text" id="room-id-input" class="input-style text-center" placeholder="Enter Room ID">
                    <button id="join-room-btn" class="btn btn-secondary !mt-2">Join Room</button>
                </div>
            </div>
            
            <div id="room-id-display" class="hidden p-3 bg-gray-100 rounded-lg mt-4">
                <p class="text-sm text-gray-600">Share this Room ID with your friend:</p>
                <div class="flex items-center justify-center mt-2">
                    <strong id="room-id-text" class="text-2xl text-indigo-600 tracking-widest"></strong>
                    <button id="copy-room-id-btn" class="ml-4 p-2 rounded-md hover:bg-gray-200 focus:outline-none" title="Copy Room ID">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    </button>
                </div>
            </div>

            <div id="remote-game-area" class="hidden">
                 <p id="remote-instruction-text" class="text-center text-gray-500 mt-2">Waiting for partner...</p>
                 <h2 id="remote-round-display" class="text-xl font-semibold text-center text-gray-600">Round 1</h2>
                 <div id="remote-input-container">
                     <div id="remote-input-area">
                         <label id="remote-word-label" for="remote-word-input" class="block text-sm font-medium text-gray-700">Your Word</label>
                         <input type="text" id="remote-word-input" class="input-style" placeholder="Enter word...">
                         <p id="remote-word-error" class="text-red-500 text-sm mt-1 hidden"></p>
                     </div>
                     <button id="remote-main-button" class="btn btn-primary" disabled>Say It!</button>
                 </div>
                 <button id="cancel-room-btn" class="btn btn-danger hidden">Cancel</button>
            </div>
        </div>

        <!-- =========== UNIVERSAL RESULTS AREA =========== -->
        <div id="results" class="pt-4 text-center space-y-4 hidden">
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-gray-100 rounded-lg"><p class="text-sm text-gray-500">Player 1 Said:</p><p id="word1-display" class="text-xl font-semibold text-gray-800 break-words"></p></div>
                <div class="p-4 bg-gray-100 rounded-lg"><p class="text-sm text-gray-500">Player 2 Said:</p><p id="word2-display" class="text-xl font-semibold text-gray-800 break-words"></p></div>
            </div>
            <div id="status-container" class="p-4 rounded-lg"><p id="status" class="text-2xl font-bold"></p></div>
            <button id="next-round-button" class="btn btn-secondary hidden">Next Round</button>
            <button id="play-again-button" class="btn btn-success hidden">Play Again</button>
        </div>
        
        <!-- =========== UNIVERSAL HISTORY AREA =========== -->
        <div id="history-section" class="border-t pt-4 mt-4">
            <div id="local-history-container" class="mt-2"></div>
            <div id="remote-history-container" class="mt-2 hidden"></div>
        </div>
    </div>

    <!-- =========== INFO CARDS =========== -->
    <div class="w-full max-w-lg mx-auto mt-8 space-y-8">
        <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col justify-center text-center">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">How to Play</h3>
            <p class="text-gray-600">The goal is to say the same word as your partner. If your words aren't the same, use them as inspiration for the next round until you match!</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col justify-center items-center text-center">
             <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer" title="Creative Commons BY-NC-SA 4.0">
                <img src="http://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg" alt="CC BY-NC-SA 4.0 Icon" class="mb-4 h-8" onerror="this.style.display='none'">
             </a>
             <p class="text-sm text-gray-500">This work is available under a <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">CC BY-NC-SA 4.0</a>.</p>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- STEMMER FUNCTION (Self-contained Porter2 Stemmer) ---
        var stemmer=function(){var e={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},t={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},r="[^aeiou]",i="[aeiouy]",o=r+"[^aeiouy]*",s=i+"[aeiou]*",u="^("+o+")?"+s+o,c="^("+o+")?"+s+o+"("+s+")?$",a="^("+o+")?"+s+o+s+o,f="^("+o+")?"+i;return function(r){var i,l,p,d,h,m,v;if(r.length<3)return r;if("y"==(p=r.substr(0,1)))r=p.toUpperCase()+r.substr(1);if((d=/^(.+?)(ss|i)es$/).test(r))r=r.replace(d,"$1$2");else if((h=/^(.+?)([^s])s$/).test(r))r=r.replace(h,"$1$2");if((d=/^(.+?)eed$/).test(r)){if((i=d.exec(r),d=new RegExp(u),d.test(i[1])))d=/.$/,r=r.replace(d,"")}else if((h=/^(.+?)(ed|ing)$/).test(r))i=h.exec(r),l=i[1],(h=new RegExp(f)).test(l)&&(r=l,(h=/(at|bl|iz)$/).test(r)?r+="e":(m=new RegExp("([^aeiouylsz])\\1$")).test(r)?(d=/.$/,r=r.replace(d,"")):(v=new RegExp("^"+o+i+"[^aeiouwxy]$")).test(r)&&(r+="e"));if((d=/^(.+?)y$/).test(r))i=d.exec(r),l=i[1],(d=new RegExp(f)).test(l)&&(r=l+"i");if((d=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/).test(r))i=d.exec(r),l=i[1],p=i[2],(d=new RegExp(u)).test(l)&&(r=l+e[p]);if((d=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/).test(r))i=d.exec(r),l=i[1],p=i[2],(d=new RegExp(u)).test(l)&&(r=l+t[p]);if((d=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/).test(r)||(h=/^(.+?)(s|t)(ion)$/).test(r))i=(d=d.exec(r))||h.exec(r),l=i[1],(d=new RegExp(a)).test(l)&&(r=l);if((d=/^(.+?)e$/).test(r))i=d.exec(r),l=i[1],(d=new RegExp(a),h=new RegExp(c),m=new RegExp("^"+o+i+"[^aeiouwxy]$"),d.test(l)||h.test(l)&&!m.test(l))&&(r=l);if((d=/ll$/).test(r)&&(h=new RegExp(a)).test(r))d=/.$/,r=r.replace(d,"");if("y"==p)r=p.toLowerCase()+r.substr(1);return r}}();
        
        // --- GLOBAL STATE ---
        let db, auth, userId;
        let activeMode = 'local';
        let unsubscribeFromRoom;
        let currentRoomId;
        let lastSeenRound = 0; // Variable to track the round for the remote client
        const wordList = [
            'bottle', 'stapler', 'window', 'picture', 'blanket', 'computer',
            'keyboard', 'monitor', 'speaker', 'headset', 'charger', 'notebook',
            'pencil', 'backpack', 'wallet', 'mirror', 'towel', 'pillow',
            'remote', 'curtain', 'dresser', 'cabinet', 'toaster', 'blender', 'kettle'
        ];

        // --- UI ELEMENTS ---
        const ui = {
            local: {
                tab: document.getElementById('local-tab'),
                content: document.getElementById('local-mode-content'),
                instruction: document.getElementById('local-instruction-text'),
                roundDisplay: document.getElementById('local-round-display'),
                gameArea: document.getElementById('local-game-area'),
                p1Turn: document.getElementById('local-player1-turn'),
                p2Turn: document.getElementById('local-player2-turn'),
                word1Input: document.getElementById('local-word1'),
                word2Input: document.getElementById('local-word2'),
                word1Error: document.getElementById('local-word1-error'),
                word2Error: document.getElementById('local-word2-error'),
                mainButton: document.getElementById('local-main-button'),
                historyContainer: document.getElementById('local-history-container'),
            },
            remote: {
                tab: document.getElementById('remote-tab'),
                content: document.getElementById('remote-mode-content'),
                selectionArea: document.getElementById('room-selection-area'),
                gameArea: document.getElementById('remote-game-area'),
                createBtn: document.getElementById('create-room-btn'),
                joinBtn: document.getElementById('join-room-btn'),
                roomIdInput: document.getElementById('room-id-input'),
                roomIdDisplay: document.getElementById('room-id-display'),
                roomIdText: document.getElementById('room-id-text'),
                copyBtn: document.getElementById('copy-room-id-btn'),
                instruction: document.getElementById('remote-instruction-text'),
                roundDisplay: document.getElementById('remote-round-display'),
                inputContainer: document.getElementById('remote-input-container'),
                input: document.getElementById('remote-word-input'),
                error: document.getElementById('remote-word-error'),
                mainButton: document.getElementById('remote-main-button'),
                cancelBtn: document.getElementById('cancel-room-btn'),
                historyContainer: document.getElementById('remote-history-container'),
            },
            results: {
                area: document.getElementById('results'),
                word1Display: document.getElementById('word1-display'),
                word2Display: document.getElementById('word2-display'),
                statusContainer: document.getElementById('status-container'),
                status: document.getElementById('status'),
                nextRoundBtn: document.getElementById('next-round-button'),
                playAgainBtn: document.getElementById('play-again-button'),
            },
            history: {
                section: document.getElementById('history-section'),
                localContainer: document.getElementById('local-history-container'),
                remoteContainer: document.getElementById('remote-history-container'),
            }
        };

        // --- GAME STATE (LOCAL) ---
        let localState = { round: 1, currentPlayer: 1, word1: '', history: [] };
        
        // --- HELPER FUNCTIONS ---
        function getRandomWord() {
            return wordList[Math.floor(Math.random() * wordList.length)];
        }

        function setRandomPlaceholder(inputElement) {
            inputElement.placeholder = `e.g., ${getRandomWord()}`;
        }

        function showInputError(inputEl, errorEl, message) {
            inputEl.classList.add('input-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function clearInputError(inputEl, errorEl) {
            inputEl.classList.remove('input-error');
            errorEl.classList.add('hidden');
        }

        function getWordsFromHistory(history) {
            if (!history) return [];
            const words = [];
            history.forEach(round => {
                words.push(round.p1);
                words.push(round.p2);
            });
            return words;
        }

        function isWordSimilarToUsed(newWord, usedWordsArray) {
            if (!usedWordsArray || usedWordsArray.length === 0) return false;

            const normalizedNewWord = newWord.toLowerCase();
            const stemOfNewWord = stemmer(normalizedNewWord);

            // Check for direct and stem matches.
            for (const usedWord of usedWordsArray) {
                const normalizedUsedWord = usedWord.toLowerCase();
                if (normalizedNewWord === normalizedUsedWord) return true; // Direct match
                if (stemOfNewWord === stemmer(normalizedUsedWord)) return true; // Stem match
            }

            return false;
        }

        // --- TAB SWITCHING ---
        function switchTab(mode) {
            if (activeMode === 'remote' && currentRoomId) {
                cancelRoom(true);
            }
            if (activeMode === 'local') {
                playLocalAgain();
            }

            activeMode = mode;
            const isLocal = mode === 'local';
            ui.local.tab.classList.toggle('tab-active', isLocal);
            ui.local.tab.classList.toggle('tab-inactive', !isLocal);
            ui.remote.tab.classList.toggle('tab-active', !isLocal);
            ui.remote.tab.classList.toggle('tab-inactive', isLocal);
            
            ui.local.content.classList.toggle('hidden', !isLocal);
            ui.remote.content.classList.toggle('hidden', isLocal);
            
            ui.history.localContainer.classList.toggle('hidden', !isLocal);
            ui.history.remoteContainer.classList.toggle('hidden', isLocal);

            ui.results.area.classList.add('hidden');
        }

        // --- RENDER HISTORY ---
        function renderHistory(historyData, container) {
            if (!historyData || historyData.length === 0) {
                container.innerHTML = ''; // Clear history if empty
                return;
            }
            let tableHTML = '<table class="w-full text-sm text-left text-gray-500"> <thead class="text-xs text-gray-700 uppercase bg-gray-50"> <tr> <th scope="col" class="px-6 py-3">Round</th> <th scope="col" class="px-6 py-3">Player 1</th> <th scope="col" class="px-6 py-3">Player 2</th> </tr> </thead> <tbody>';
            historyData.forEach(round => {
                tableHTML += `<tr class="bg-white border-b"> <td class="px-6 py-4 font-medium text-gray-900">${round.round}</td> <td class="px-6 py-4">${round.p1}</td> <td class="px-6 py-4">${round.p2}</td> </tr>`;
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // --- UNIVERSAL RESULTS LOGIC ---
        function showResults(word1, word2, round, isMatch) {
            ui.local.content.classList.add('hidden');
            ui.remote.content.classList.add('hidden');
            ui.results.area.classList.remove('hidden');
            ui.results.word1Display.textContent = word1;
            ui.results.word2Display.textContent = word2;

            if (isMatch) {
                ui.results.status.innerHTML = `Same! <br><span class="text-lg font-normal">It took you ${round} round${round > 1 ? 's' : ''}.</span>`;
                ui.results.statusContainer.className = 'p-4 rounded-lg bg-green-100';
                ui.results.playAgainBtn.classList.remove('hidden');
                ui.results.nextRoundBtn.classList.add('hidden');
            } else {
                ui.results.status.textContent = 'Not the same';
                ui.results.statusContainer.className = 'p-4 rounded-lg bg-red-100';
                ui.results.nextRoundBtn.classList.remove('hidden');
                ui.results.playAgainBtn.classList.add('hidden');
            }
        }

        // --- LOCAL GAME LOGIC ---
        function handleLocalTurn() {
            const usedWords = getWordsFromHistory(localState.history);

            if (localState.currentPlayer === 1) {
                const word1 = ui.local.word1Input.value.trim();
                if (!word1) { alert("Player 1, please enter a word."); return; }
                if (isWordSimilarToUsed(word1, usedWords)) {
                    showInputError(ui.local.word1Input, ui.local.word1Error, "This word is too similar to one already used.");
                    return;
                }
                
                localState.word1 = word1;
                ui.local.p1Turn.classList.add('hidden');
                ui.local.p2Turn.classList.remove('hidden');
                ui.local.word2Input.focus();
                setRandomPlaceholder(ui.local.word2Input);
                ui.local.mainButton.textContent = 'Say It!';
                ui.local.instruction.textContent = "Player 2, enter your word.";
                localState.currentPlayer = 2;
            } else {
                const word2 = ui.local.word2Input.value.trim();
                if (!word2) { alert("Player 2, please enter a word."); return; }
                
                // Check for reuse against previous rounds only.
                if (isWordSimilarToUsed(word2, usedWords)) {
                    showInputError(ui.local.word2Input, ui.local.word2Error, "This word is too similar to one already used.");
                    return;
                }
                
                localState.history.push({ round: localState.round, p1: localState.word1, p2: word2 });
                renderHistory(localState.history, ui.local.historyContainer);
                
                const directMatch = localState.word1.toLowerCase() === word2.toLowerCase();
                const stemMatch = stemmer(localState.word1.toLowerCase()) === stemmer(word2.toLowerCase());
                showResults(localState.word1, word2, localState.round, directMatch || stemMatch);
            }
        }
        function setupLocalNextRound() {
            localState.round++;
            localState.currentPlayer = 1;
            localState.word1 = '';
            ui.local.word1Input.value = '';
            ui.local.word2Input.value = '';
            setRandomPlaceholder(ui.local.word1Input);
            setRandomPlaceholder(ui.local.word2Input);
            ui.results.area.classList.add('hidden');
            ui.local.content.classList.remove('hidden');
            ui.local.gameArea.classList.remove('hidden');
            ui.local.p2Turn.classList.add('hidden');
            ui.local.p1Turn.classList.remove('hidden');
            ui.local.word1Input.focus();
            ui.local.mainButton.textContent = 'Say It!';
            ui.local.roundDisplay.textContent = `Round ${localState.round}`;
            ui.local.instruction.textContent = "Player 1, enter a word.";
        }
        function playLocalAgain() {
            localState.round = 0; 
            localState.history = [];
            renderHistory(localState.history, ui.local.historyContainer);
            setupLocalNextRound();
        }

        // --- REMOTE GAME LOGIC ---
        async function createRoom() {
            try {
                lastSeenRound = 1;
                const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const roomRef = doc(db, "rooms", roomId);
                await setDoc(roomRef, {
                    players: { [userId]: 'p1' },
                    round: 1,
                    gameState: 'waiting',
                    words: { p1: '', p2: '' },
                    history: [],
                    readyForNextRound: [],
                    readyForNewGame: []
                });
                listenToRoom(roomId);
            } catch (error) {
                console.error("Error creating room:", error);
                alert("Could not create room. Please check the console for errors and ensure your Firestore rules are correct.");
            }
        }
        async function joinRoom() {
            const roomId = ui.remote.roomIdInput.value.trim().toUpperCase();
            if (!roomId) { alert("Please enter a Room ID."); return; }
            const roomRef = doc(db, "rooms", roomId);
            try {
                const roomSnap = await getDoc(roomRef);
                if (!roomSnap.exists()) { alert("Room not found."); return; }
                const roomData = roomSnap.data();
                lastSeenRound = roomData.round;
                if (Object.keys(roomData.players).length >= 2 && !roomData.players[userId]) {
                    alert("This room is full."); return;
                }
                if (!roomData.players[userId]) {
                    await updateDoc(roomRef, { [`players.${userId}`]: 'p2' });
                }
                listenToRoom(roomId);
            } catch (error) {
                console.error("Error joining room:", error);
                alert("Could not join room. Please check the Room ID and your Firestore rules.");
            }
        }
        function listenToRoom(roomId) {
            currentRoomId = roomId;
            ui.remote.selectionArea.classList.add('hidden');
            ui.remote.content.classList.remove('hidden');
            ui.remote.gameArea.classList.remove('hidden');
            ui.remote.roomIdText.textContent = roomId;
            ui.remote.roomIdDisplay.classList.remove('hidden');

            const roomRef = doc(db, "rooms", roomId);
            unsubscribeFromRoom = onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    updateRemoteUI(doc.data());
                } else {
                    alert("The game room was closed.");
                    cancelRoom(false);
                }
            });
        }
        async function cancelRoom(deleteRoom = true) {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
                unsubscribeFromRoom = null;
            }
            if(currentRoomId && deleteRoom) {
                const roomRef = doc(db, "rooms", currentRoomId);
                await deleteDoc(roomRef);
            }
            currentRoomId = null;
            lastSeenRound = 0;
            ui.remote.gameArea.classList.add('hidden');
            ui.remote.selectionArea.classList.remove('hidden');
            ui.remote.roomIdDisplay.classList.add('hidden');
            ui.remote.cancelBtn.classList.add('hidden');
            renderHistory([], ui.remote.historyContainer);
        }
        function updateRemoteUI(data) {
            const { players, round, gameState, words, history, readyForNextRound, readyForNewGame } = data;
            renderHistory(history, ui.remote.historyContainer);
            const myPlayerKey = players[userId];
            if (!myPlayerKey) return;
            const isPlayer1 = myPlayerKey === 'p1';
            const numPlayers = Object.keys(players).length;

            const directMatch = words.p1.toLowerCase() === words.p2.toLowerCase();
            const stemMatch = stemmer(words.p1.toLowerCase()) === stemmer(words.p2.toLowerCase());
            const isMatch = (words.p1 && words.p2) && (directMatch || stemMatch);

            if (gameState === 'results') {
                ui.remote.roomIdDisplay.classList.add('hidden');
                showResults(words.p1, words.p2, round, isMatch);
                
                if(isMatch) {
                    const iAmReady = readyForNewGame && readyForNewGame.includes(userId);
                    ui.results.playAgainBtn.disabled = iAmReady;
                    ui.results.playAgainBtn.textContent = iAmReady ? 'Waiting for partner...' : 'Play Again';
                } else {
                    const iAmReady = readyForNextRound.includes(userId);
                    ui.results.nextRoundBtn.disabled = iAmReady;
                    ui.results.nextRoundBtn.textContent = iAmReady ? 'Waiting for partner...' : 'Next Round';
                }
                return;
            }
            
            ui.remote.content.classList.remove('hidden');
            ui.remote.gameArea.classList.remove('hidden');
            ui.results.area.classList.add('hidden');

            if (numPlayers < 2) {
                ui.remote.instruction.textContent = 'Waiting for partner...';
                ui.remote.roundDisplay.classList.add('hidden');
                ui.remote.inputContainer.classList.add('hidden');
                ui.remote.cancelBtn.classList.remove('hidden');
                return;
            }
            
            ui.remote.roomIdDisplay.classList.add('hidden');
            ui.remote.cancelBtn.classList.add('hidden');
            ui.remote.roundDisplay.classList.remove('hidden');
            ui.remote.inputContainer.classList.remove('hidden');
            ui.remote.roundDisplay.textContent = `Round ${round}`;

            const myWord = words[myPlayerKey];

            if (myWord) {
                ui.remote.instruction.textContent = 'Your word is locked in. Waiting for partner...';
                ui.remote.mainButton.disabled = true;
                ui.remote.input.disabled = true;
                ui.remote.input.value = myWord;
            } else {
                ui.remote.instruction.textContent = `Your turn, Player ${isPlayer1 ? 1 : 2}.`;
                ui.remote.mainButton.disabled = false;
                ui.remote.input.disabled = false;
                setRandomPlaceholder(ui.remote.input);
                // Only clear the input if the round has advanced
                if (lastSeenRound !== round) {
                    ui.remote.input.value = '';
                }
            }
            // Update the last seen round
            lastSeenRound = round;
        }
        async function submitRemoteWord() {
            const word = ui.remote.input.value.trim();
            if (!word) { alert("Please enter a word."); return; }
            const roomRef = doc(db, "rooms", currentRoomId);
            try {
                const roomSnap = await getDoc(roomRef);
                const roomData = roomSnap.data();
                
                const usedWords = getWordsFromHistory(roomData.history);
                if(isWordSimilarToUsed(word, usedWords)) {
                    showInputError(ui.remote.input, ui.remote.error, "This word is too similar to one already used.");
                    return;
                }

                const myPlayerKey = roomData.players[userId];
                const theirPlayerKey = myPlayerKey === 'p1' ? 'p2' : 'p1';
                const theirWord = roomData.words[theirPlayerKey];

                const updates = { [`words.${myPlayerKey}`]: word };

                if (theirWord) {
                    updates.gameState = 'results';
                    const p1Word = myPlayerKey === 'p1' ? word : theirWord;
                    const p2Word = myPlayerKey === 'p2' ? word : theirWord;
                    
                    const newHistoryEntry = { round: roomData.round, p1: p1Word, p2: p2Word };
                    updates.history = arrayUnion(newHistoryEntry);
                }
                await updateDoc(roomRef, updates);
            } catch (error) {
                 console.error("Error submitting word:", error);
                alert("Could not submit word. Please check your connection and Firestore rules.");
            }
        }
        async function signalReadyForNextRound() {
            const roomRef = doc(db, "rooms", currentRoomId);
            ui.results.nextRoundBtn.disabled = true;
            ui.results.nextRoundBtn.textContent = 'Waiting for partner...';
            
            await updateDoc(roomRef, { readyForNextRound: arrayUnion(userId) });

            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();
            if (roomData.readyForNextRound.length === 2) {
                await updateDoc(roomRef, {
                    round: roomData.round + 1,
                    gameState: 'waiting',
                    words: { p1: '', p2: '' },
                    readyForNextRound: []
                });
            }
        }
        async function signalPlayAgain() {
            const roomRef = doc(db, "rooms", currentRoomId);
            ui.results.playAgainBtn.disabled = true;
            ui.results.playAgainBtn.textContent = 'Waiting for partner...';
            
            await updateDoc(roomRef, { readyForNewGame: arrayUnion(userId) });

            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();
            if (roomData.readyForNewGame.length === 2) {
                await updateDoc(roomRef, {
                    round: 1,
                    gameState: 'waiting',
                    words: { p1: '', p2: '' },
                    history: [],
                    readyForNextRound: [],
                    readyForNewGame: []
                });
            }
        }

        // --- UNIVERSAL EVENT HANDLERS ---
        ui.results.nextRoundBtn.addEventListener('click', () => {
            if (activeMode === 'local') setupLocalNextRound();
            else signalReadyForNextRound();
        });
        ui.results.playAgainBtn.addEventListener('click', () => {
            if (activeMode === 'local') playLocalAgain();
            else signalPlayAgain();
        });
        
        // --- INITIALIZATION ---
        window.onload = async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBn0gENIkoO8z9-oK-wmlPXYkmVMNMkV3M",
                authDomain: "say-the-same-thing-19372.firebaseapp.com",
                projectId: "say-the-same-thing-19372",
                storageBucket: "say-the-same-thing-19372.firebasestorage.app",
                messagingSenderId: "471937812902",
                appId: "1:471937812902:web:67b671276515eb4b1a2767",
                measurementId: "G-7VMTYPTM7J"
            };

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                
                renderHistory([], ui.local.historyContainer);
                renderHistory([], ui.remote.historyContainer);
                
                setRandomPlaceholder(ui.local.word1Input);
                setRandomPlaceholder(ui.local.word2Input);
                setRandomPlaceholder(ui.remote.input);

                ui.local.tab.addEventListener('click', () => switchTab('local'));
                ui.remote.tab.addEventListener('click', () => switchTab('remote'));
                ui.local.mainButton.addEventListener('click', handleLocalTurn);
                ui.remote.createBtn.addEventListener('click', createRoom);
                ui.remote.joinBtn.addEventListener('click', joinRoom);
                ui.remote.cancelBtn.addEventListener('click', () => cancelRoom(true));
                ui.remote.mainButton.addEventListener('click', submitRemoteWord);
                ui.remote.copyBtn.addEventListener('click', () => {
                    const textArea = document.createElement("textarea");
                    textArea.value = ui.remote.roomIdText.textContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert("Room ID copied to clipboard!");
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                    }
                    document.body.removeChild(textArea);
                });
                
                ui.local.word1Input.addEventListener('input', () => clearInputError(ui.local.word1Input, ui.local.word1Error));
                ui.local.word2Input.addEventListener('input', () => clearInputError(ui.local.word2Input, ui.local.word2Error));
                ui.remote.input.addEventListener('input', () => clearInputError(ui.remote.input, ui.remote.error));

                ui.local.word1Input.addEventListener('keypress', (e) => e.key === 'Enter' && ui.local.mainButton.click());
                ui.local.word2Input.addEventListener('keypress', (e) => e.key === 'Enter' && ui.local.mainButton.click());
                ui.remote.input.addEventListener('keypress', (e) => e.key === 'Enter' && ui.remote.mainButton.click());

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Could not connect to the game service. Please check your Firestore rules.");
                ui.remote.tab.disabled = true;
            }
        };
    </script>
</body>
</html>
